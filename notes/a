# ğŸ”§ ê°•ì˜ì²˜ëŸ¼ í•˜ë ¤ë©´ (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ í•´ê²°)

# âŒ í˜„ì¬ ì‹¤íŒ¨í•˜ëŠ” ëª…ë ¹ì–´
docker run -it --rm --network=pg-network taxi_ingest:v001 --pg_user=root --pg_pass=root --pg_host=localhost --pg_port=5432 --pg_db=ny_taxi --target_table=yellow_taxi_trips_2021_1 --year=2021 --month=1 --chunksize=100000

# âœ… ê°•ì˜ ë°©ì‹ëŒ€ë¡œ ìˆ˜ì •í•œ ëª…ë ¹ì–´ë“¤

# 1ë‹¨ê³„: ê¸°ì¡´ PostgreSQL ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ
docker stop pgdatabase
docker rm pgdatabase

# 2ë‹¨ê³„: PostgreSQLì„ pg-networkì— ì—°ê²°í•´ì„œ ì‹¤í–‰
docker run -it --rm \
  -e POSTGRES_USER="root" \
  -e POSTGRES_PASSWORD="root" \
  -e POSTGRES_DB="ny_taxi" \
  -v ny_taxi_postgres_data:/var/lib/postgresql \
  -p 5432:5432 \
  --network=pg-network \
  --name pgdatabase \
  postgres:18

# 3ë‹¨ê³„: ë°ì´í„° ingest ì‹¤í–‰ (í˜¸ìŠ¤íŠ¸ëª…ì„ ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ)
docker run --rm \
  --network=pipeline_default \
  taxi_ingest:v001 \
  --pg_user=root \
  --pg_pass=root \
  --pg_host=pgdatabase \
  --pg_port=5432 \
  --pg_db=ny_taxi \
  --target_table=yellow_taxi_trips_2021_1 \
  --chunksize=100000

# ğŸ’¡ ë©”ëª¨: pg-networkë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•œ ê²½ìš°
# docker-compose.yaml íŒŒì¼ì—ì„œ networks: ì„¹ì…˜ì„ ì™„ì „íˆ ì œê±°í•˜ì„¸ìš”
# Docker Composeê°€ ìë™ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ ìƒì„±í•˜ì—¬ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤

docker run -it \
  -e PGADMIN_DEFAULT_EMAIL="admin@admin.com" \
  -e PGADMIN_DEFAULT_PASSWORD="root" \
  -v pgadmin_data:/var/lib/pgadmin \
  -p 8085:80 \
  --network=pg-network \
  --name pgadmin \
  dpage/pgadmin4


# ğŸš€ ì¬ë¶€íŒ… í›„ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì¬ì‹œì‘ ê°€ì´ë“œ
# ===========================================

# 1ë‹¨ê³„: Docker Desktop ì‹¤í–‰ í™•ì¸
# - Docker Desktopì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
# - ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ Docker Desktop ì‹œì‘

# 2ë‹¨ê³„: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd c:\dataeng-zoomcamp\01-docker-terraform\pipeline

# 3ë‹¨ê³„: Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
docker network create pg-network

# 4ë‹¨ê³„: PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -it --rm \
  -e POSTGRES_USER="root" \
  -e POSTGRES_PASSWORD="root" \
  -e POSTGRES_DB="ny_taxi" \
  -v ny_taxi_postgres_data:/var/lib/postgresql \
  -p 5432:5432 \
  --network=pg-network \
  --name=pgdatabase \
  postgres:18

